# 增强的挖矿日志系统

## 概述

基于您的要求，我们已经改进了cgminer-rs的日志系统，特别是添加了获取题目和提交题目的详细日志记录，参考了其他挖矿软件的最佳实践。

## 新增的日志功能

### 1. 工作获取日志（mining.notify）

当矿池发送新的挖矿工作时，系统会记录详细信息：

```
🌊 矿池 0 检测到新区块 | 🔄 清理旧工作 | 作业ID: 4d16b6f85af6e219 | 前块哈希: 4d16b6f85af6e219... | 难度: 16384.00
   📋 完整前块哈希: 4d16b6f85af6e2198f44ae2a6de67f78487ae5611b77c6c0440b921e00000000
   🎯 当前挖矿难度: 🎯 16.38K
```

**记录内容：**
- 矿池ID
- 工作类型（新工作/清理旧工作）
- 作业ID
- 前块哈希（简化和完整版本）
- 当前难度

### 2. 份额提交日志（mining.submit）

#### 提交详情
```
📤 设备 1 -> 矿池 0 | 提交份额详情:
   🆔 作业ID: 4d16b6f85af6e219
   🎲 随机数: 0x12345678
   ⏰ 时间戳: 0x6422ca0e
   🔢 ExtraNonce2: deadbeef
   🎯 份额难度: 🎯 32.77K
```

#### 提交结果
```
📥 矿池 0 响应 | 设备 1 | ✅ 接受 | 难度: 32768.00
📥 矿池 0 响应 | 设备 2 | ❌ 拒绝 | 难度: 32768.00 | 原因: duplicate share
```

### 3. 难度调整日志

```
🎯 矿池 0 难度调整 | 📈 🎯 16.38K -> 🎯 32.77K | 变化: 100.0%
```

### 4. 矿池连接状态日志

```
🌊 矿池 0 🟢 | stratum+tcp://btc.f2pool.com:1314 | 连接成功
🌊 矿池 0 🔴 | stratum+tcp://btc.f2pool.com:1314 | 断开原因: 网络错误
```

### 5. Stratum协议消息日志

在详细模式下，记录所有Stratum协议消息：

```
🔗 Stratum 发送 | 方法: mining.subscribe | 消息: {"id":1,"method":"mining.subscribe","params":["cgminer-rs/1.0.0"]}
🔗 Stratum 接收 | 方法: mining.notify | 消息: {"id":null,"method":"mining.notify","params":[...]}
```

## 参考的挖矿软件特性

我们的日志系统参考了以下挖矿软件的最佳实践：

### 1. CGMiner 原版
- "Stratum from pool X detected new block" 格式
- 详细的份额提交和接受/拒绝信息
- 网络连接状态变化记录

### 2. BFGMiner
- 设备状态的详细记录
- 算力统计和趋势显示
- 错误和警告的分类记录

### 3. CPUMiner
- 简洁但信息丰富的日志格式
- 性能统计的定期报告

## 日志级别和详细模式

### 标准模式
- 显示关键事件（连接、新工作、份额结果）
- 简化的份额提交信息
- 错误和警告信息

### 详细模式（verbose=true）
- 完整的Stratum协议消息
- 详细的份额提交参数
- 完整的哈希值和技术细节
- 工作分发信息
- 网络状态统计

## 使用示例

```rust
// 创建日志记录器
let mining_logger = MiningLogger::new(true); // 启用详细模式

// 在Stratum客户端中使用
let stratum_client = StratumClient::new(
    url,
    username,
    password,
    pool_id,
    verbose
).await?;
```

## 日志输出格式

所有日志都使用统一的格式：
- 🌊 矿池相关
- 📤 份额提交
- 📥 矿池响应
- 🔧 设备状态
- 🎯 难度调整
- 🔗 网络通信
- ❌ 错误信息
- ⚠️ 警告信息

## 性能考虑

- 日志记录是异步的，不会阻塞挖矿操作
- 详细模式可以动态开启/关闭
- 支持日志级别过滤
- 自动格式化数值（算力、难度、温度等）

## 配置选项

在配置文件中可以设置：
```toml
[logging]
verbose = true
level = "info"
show_stratum_messages = true
```

## 与其他挖矿软件的兼容性

我们的日志格式与标准挖矿软件兼容，便于：
- 日志分析工具的集成
- 监控系统的对接
- 故障排查和性能分析

## 总结

改进后的日志系统提供了：
1. **完整的工作流程记录** - 从接收工作到提交份额的全过程
2. **详细的技术信息** - 包括所有Stratum协议细节
3. **美观的格式化输出** - 使用图标和颜色增强可读性
4. **灵活的详细级别** - 支持标准和详细两种模式
5. **行业标准兼容** - 参考主流挖矿软件的日志格式

这些改进使cgminer-rs的日志系统达到了专业挖矿软件的标准，为用户提供了全面的挖矿操作可视性。
